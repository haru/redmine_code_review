<%
# Code Review plugin for Redmine
# Copyright (C) 2009-2012  Haruyuki Iida
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
-%>

<div class="code_review">

</div>

<div id="review-form-frame">
  <div id="review-form">

  </div>
</div>

<div id="code-review-assign-form" />

<div id="code-review-assign-link" style="text-align: right;">
  <%
   assignments = if @change
     @change.code_review_assignments
   elsif @attachment
     @attachment.code_review_assignments
   end
  -%>

  <% if User.current.allowed_to?(:assign_code_review, @project) %>
    <%= l :review_assignments %>:
    <%= show_assignments assignments, @project, {:action_type => @action_type, :rev => @rev, :rev_to => @rev_to, :path => @path, :change_id => @change.try(:id), :attachment_id => @attachment.try(:id)} %>
  <% end %>
</div>

<script type="text/javascript">
  var repository_id = "<%= j @repository_id %>";
  var add_form_title = "<%= l(:label_add_review) %>";
  var review_dialog_title = "<%= l(:code_review) %>";
  var addReviewUrl = '<%= j url_for :controller => 'code_review', :action => 'new', :id => @project %>';
  var is_readonly = <%= !authorize_for('code_review', 'new') %>;
  var is_diff = <%= @action_type == 'diff' or (@attachment and @attachment.is_diff?) %>;
  var action_type = '<%= j @action_type %>';
  var rev = '<%= j @rev %>';
  var rev_to = '<%= j @rev_to %>';
  var path = '<%= j @path -%>';

  setAddReviewButton(addReviewUrl, '<%= change.try :id %>', '<%= j image_tag('edit.png', :alt => l(:label_add_review), :title => l(:label_add_review)) %>', is_readonly, is_diff, '<%= @attachment.try :id %>' );

  var showReviewUrl = '<%= j url_for :controller => 'code_review', :action => 'show', :id=>@project %>';
  var showReviewImageTag = '<%= j image_tag('review.png', :plugin => 'redmine_code_review', :alt => l(:label_show_review), :title => l(:label_show_review)) %>';
  var showClosedReviewImageTag = '<%= j image_tag('closed_review.png', :plugin => 'redmine_code_review', :alt => l(:label_show_review), :title => l(:label_show_review)) %>';

  <% for review in @reviews do %>
    setShowReviewButton(<%= review.line %>, <%= review.id %>, <%= review.is_closed? %>, <%= review.file_count %> );
  <% end %>

  <% if @show_review_id -%>
    popupReview(<%= @show_review_id.to_i %>, showReviewUrl);
  <% end -%>
  $('#content table.filecontent:first').before($('#code-review-assign-link'));
</script>
